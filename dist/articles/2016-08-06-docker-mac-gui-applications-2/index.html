<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v4.2.6"><title>Containerize GUI Applications on Mac - II | Ganessh Kumar</title><link rel="sitemap" href="/sitemap-index.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet"><link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"><script dangerouslySetInnerHTML="[object Object]"></script><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/2013-09-01-learn-unlearn-relearn.l15eNEwx.css" /><script type="module" src="/_astro/hoisted.l-JsOPk0.js"></script></head> <body> <header> <nav class="bg-white flex border-gray-200 dark:bg-gray-900"> <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4"> <button data-collapse-toggle="navbar-default" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <div class="hidden w-full md:block md:w-auto" id="navbar-default"> <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700"> <li class="mb-0 z-10 text-slate-700"> <a class="no-underline" href="/"> <div class="text-slate-900 cursor-pointer"> Home </div> </a> </li> <li class="mb-0 z-10 font-semibold underline decoration-sky-500 underline-offset-2"> <a class="no-underline" href="/articles"> <div class="text-slate-900 cursor-pointer"> Articles </div> </a> </li> <li class="mb-0 z-10 text-slate-700"> <a class="no-underline" href="/projects"> <div class="text-slate-900 cursor-pointer"> Projects </div> </a> </li>  <li class="mb-0 z-10 text-slate-700"> <a class="no-underline" href="/about"> <div class="text-slate-900 cursor-pointer"> About </div> </a> </li> </ul> </div> </div> </nav> </header>  <div class="container mx-auto w-100 lg:w-2/3 2xl:w-1/2"> <h1 class="font-bold text-4xl cursor-default tracking-wide pb-2 border-b border-sky-600">Containerize GUI Applications on Mac - II</h1> <div class="flex flex-row justify-between mt-2 mb-10"> <div class="text-slate-500 uppercase text-sm">August 5, 2016</div> <div class="text-slate-500 uppercase text-sm">docker</div> </div> <div class="markdown"> <p>In the <a href="http://www.ganesshkumar.com/2016/08/05/docker-mac-gui-appications.html">previous post</a>, we ran firefox inside a container on OS X. To allow connection from the container to the X11, we used <code>xhost + $(hostname)</code>. This gives rise to serious security vulnerability.</p>
<p>Let’s list the entries in ACL before adding our local machine</p>
<pre class="language-shell"><code is:raw="" class="language-shell">$ /usr/X11R6/bin/xhost
access control enabled, only authorized clients can connect</code></pre>
<p>Now let’s add our localmachine to ACL</p>
<pre class="language-shell"><code is:raw="" class="language-shell">$ /usr/X11R6/bin/xhost + <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>
<span class="token operator">&#x3C;</span>my-machine-name<span class="token operator">></span>.local being added to access control list</code></pre>
<p>Let’s list the entries in ACL</p>
<pre class="language-shell"><code is:raw="" class="language-shell">$ /usr/X11R6/bin/xhost
access control enabled, only authorized clients can connect
INET:192.168.1.x
INET6:ganessh-macbook.local</code></pre>
<p>Our ip address has been added to the ACL. If you are switching between networks regularly or your dynamic ip address gets renewed to a new address, X11 will stop allowing connection from the container. You <strong>must</strong> remove the old ip address from the ACL, else Bob can use your old ip address(in your network) and hijack your X display.</p>
<p>Let’s remove our machine from ACL. Removing hostname will remove both hostname and ip address entries from ACL</p>
<pre class="language-shell"><code is:raw="" class="language-shell">$ /usr/X11R6/bin/xhost - <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>
<span class="token operator">&#x3C;</span>my-machine-name<span class="token operator">></span>.local being removed from access control list

$ /usr/X11R6/bin/xhost
access control enabled, only authorized clients can connect</code></pre>
<p>Using <code>xhost +</code> or open X display is one of the <a href="http://www.nikhef.nl/~mjg/xhost_plus.html">high rated system vulnerabilities</a>. So let’s use another(safer) way in this post. The drawback of this method is that it requires us to extend the image and create a local image containing our xauth file.</p>
<ul>
<li><strong>Extending the image</strong> to include our user to authenticate with x11.</li>
</ul>
<pre class="language-dockerfile"><code is:raw="" class="language-dockerfile"><span class="token comment"># Dockerfile</span>
<span class="token instruction"><span class="token keyword">FROM</span> jess/firefox</span>

<span class="token instruction"><span class="token keyword">ARG</span> username</span>
<span class="token instruction"><span class="token keyword">ARG</span> uid</span>

<span class="token instruction"><span class="token keyword">ENV</span> USERNAME <span class="token variable">${user}</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> useradd -m <span class="token variable">$USERNAME</span> &#x26;&#x26; <span class="token operator">\</span>
        echo <span class="token string">"$USERNAME:$USERNAME"</span> | chpasswd &#x26;&#x26; <span class="token operator">\</span>
        usermod --shell /bin/bash <span class="token variable">$USERNAME</span> &#x26;&#x26; <span class="token operator">\</span>
        usermod  --uid <span class="token variable">${uid}</span> <span class="token variable">$USERNAME</span> &#x26;&#x26; <span class="token operator">\</span>
        groupmod --gid <span class="token variable">${uid}</span> <span class="token variable">$USERNAME</span></span>

<span class="token instruction"><span class="token keyword">USER</span> <span class="token variable">${user}</span></span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /home/<span class="token variable">${user}</span></span></code></pre>
<ul>
<li><strong>Building docker image</strong>. Note that the variables started with <code>ARG</code> reference in the Dockerfile are supplied using —build-args</li>
</ul>
<pre class="language-shell"><code is:raw="" class="language-shell">$ <span class="token function">docker</span> build --build-arg <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token environment constant">$USER</span> --build-arg <span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span> <span class="token parameter variable">-t</span> <span class="token operator">&#x3C;</span>image_name<span class="token operator">></span> <span class="token builtin class-name">.</span></code></pre>
<ul>
<li><strong>Generate xauth file</strong>. Using <code>:0</code> as our display. Note: if it complains that the file <code>/tmp/.docker.xauth</code> doesn’t exist, <code>touch</code> the file and re-run the command.</li>
</ul>
<pre class="language-shell"><code is:raw="" class="language-shell">$ /usr/X11R6/bin/xauth nlist :0 <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s/^..../ffff/'</span> <span class="token operator">|</span> /usr/X11R6/bin/xauth <span class="token parameter variable">-f</span> /tmp/.docker.xauth nmerge -</code></pre>
<ul>
<li>While <strong>starting the container</strong>, we should mount the xauth file and set the path of the file as environmental variable using the flags
<ul>
<li>-v /tmp/.docker.xauth:/tmp/.docker.xauth:rw</li>
<li>-e XAUTHORITY=/tmp/.docker.xauth</li>
</ul>
</li>
</ul>
<pre class="language-dockerfile"><code is:raw="" class="language-dockerfile">$ docker run -d \
      --memory 2gb \
      --net host \
      --cpuset-cpus 0 \
      -v /etc/localtime:/etc/localtime:ro \
      -v /tmp/.X11-unix:/tmp/.X11-unix \
      -v $HOME/docker_data/.firefox/cache:/root/.cache/mozilla \
      -v $HOME/docker_data/.firefox/mozilla:/root/.mozilla \
      -v $HOME/Downloads:/root/Downloads \
      -v /tmp/.docker.xauth:/tmp/.docker.xauth:rw -e XAUTHORITY=/tmp/.docker.xauth \
      -e DISPLAY=$ip:0 \
      -e GDK_SCALE \
      -e GDK_DPI_SCALE \
      --name firefox \
      jess/firefox</code></pre>
<p>The above run command will preserve firefox’s data on the mounted volumes.</p>
<p><strong>Issues left unfixed</strong></p>
<ul>
<li>We haven’t touched audio yet. I am yet to figure out a way to pass audio from the container to hostmachine.</li>
<li>Retina display is not properly used by the container. The fonts are not smooth on the retina screen.</li>
</ul> </div> </div>  <footer> <div class="bg-gray-800 text-center py-8"> <div class="container mx-auto w-100 lg:w-2/3 xl:1/2 text-slate-200">
Made with 💙 by <a class="visited:text-white" rel="me" href="https://github.com/ganesshkumar"><span class="text-white">Ganessh Kumar</span></a><br> <a class="hidden" rel="me" href="https://hachyderm.io/@ganesshkumar">Mastodon</a> </div> </div> </footer> </body></html>